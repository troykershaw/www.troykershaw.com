<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=author content="Troy"><meta name=description content="Description"><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="The AsyncArrow"><meta name=twitter:description content="&lsquo;Tis the season for giphing, so for my F# advent post this year we&rsquo;re going to get the top trending gif on giphy.
Giphy has a nice little api, all we need to do is send a request, then we&rsquo;ll get a response. Sounds pretty straight forward, huh? In fact, you&rsquo;ve probably created a function that takes a request and returns an asynchronous result before, à la 'Req -> Async<'Res>. Interestingly, in doing so, you&rsquo;ve defined the &lsquo;Arrow&rsquo;."><link rel=canonical href=https://www.troykershaw.com/post/the-asyncarrow/><link media=screen rel=stylesheet href=https://www.troykershaw.com/css/common.css><link media=screen rel=stylesheet href=https://www.troykershaw.com/css/content.css><link media=screen rel=stylesheet href=https://www.troykershaw.com/css/highlight.css><title>The AsyncArrow - Troy Kershaw's Website</title><script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\[\[','\]\]']],processEscapes:true,processEnvironments:true,},options:{skipHtmlTags:['script','noscript','style','textarea','pre'],}};</script><script async defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js id=MathJax-script></script><link rel=stylesheet href=https://www.troykershaw.com/css/single.css></head><body><div id=wrapper><header id=header><h1><a href=https://www.troykershaw.com/>Troy Kershaw's Website</a></h1><nav><span class=nav-bar-item><a class=link href=/>Posts</a></span>
<span class=nav-bar-item><a class=link href=/about/>About</a></span></nav></header><main id=main class=post><h1>The AsyncArrow</h1><div class=content><p>&lsquo;Tis the season for giphing, so for my <a href="https://twitter.com/search?q=%23fsadvent">F# advent</a> post this year we&rsquo;re going to get the top trending gif on giphy.</p><p><img src=http://i.giphy.com/oWA8lD03GUew8.gif alt="That&rsquo;s one excited girl"></p><p>Giphy has a nice little api, all we need to do is send a request, then we&rsquo;ll get a response. Sounds pretty straight forward, huh? In fact, you&rsquo;ve probably created a function that takes a request and returns an asynchronous result before, à la <code>'Req -> Async&lt;'Res></code>. Interestingly, in doing so, you&rsquo;ve defined the &lsquo;Arrow&rsquo;.</p><p>John Hughes, in his paper <a href=http://www.cse.chalmers.se/~rjmh/Papers/arrows.pdf>Generalising Monads to Arrows</a>, describes an arrow as <code>'a -> M&lt;'b></code> where <code>M</code> is any monad. We treat this function as a single type until it&rsquo;s time to apply the argument. In fact, you can create a type alias for the async arrow like so:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>type</span> <span class=nc>AsyncArrow</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>a</span><span class=o>,</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;</span> <span class=o>=</span> <span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;</span>
</code></pre></div><p>I won&rsquo;t be using this type alias for any actual work in this post, but visualising it like this certainly helped me gain an understanding of how they work.</p><p>What you&rsquo;ll see in this post is that by representing our async operations as arrows we get monad like properties on the input/output group.</p><p>Below is a bit of setup for your <code>fsx</code> file if you&rsquo;re following along and running the code. There&rsquo;s a few functions to help us work with <code>Async</code> and a few functions in an <code>AsyncArrow</code> module. Don&rsquo;t worry about those yet, we&rsquo;ll look at how they work later.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=o>#</span><span class=n>r</span> <span class=s>&#34;System.Net.Http&#34;</span>

<span class=k>open</span> <span class=nn>System.Net.Http</span>
<span class=k>open</span> <span class=nn>System.Text.RegularExpressions</span>
<span class=k>open</span> <span class=nn>System.Diagnostics</span>

<span class=c1>// These aliases are just so that I don&#39;t wear out my keyboard.
</span><span class=c1></span><span class=k>type</span> <span class=nc>HttpReq</span> <span class=o>=</span> <span class=n>HttpRequestMessage</span>
<span class=k>type</span> <span class=nc>HttpRes</span> <span class=o>=</span> <span class=n>HttpResponseMessage</span>

<span class=c1>// We&#39;re calling giphy, remember?
</span><span class=c1></span><span class=k>let</span> <span class=nv>giphyTrending</span> <span class=o>=</span> <span class=s>&#34;http://api.giphy.com/v1/gifs/trending&#34;</span>

<span class=c1>// A few Async functions to make bind and map easy to use
</span><span class=c1></span><span class=k>type</span> <span class=nc>Async</span> <span class=k>with</span>
  <span class=k>static</span> <span class=k>member</span> <span class=n>bind</span> <span class=o>(</span><span class=n>f</span><span class=o>:</span><span class=k>&#39;</span><span class=n>b</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;)</span> <span class=o>(</span><span class=n>a</span><span class=o>:</span><span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span> <span class=o>:</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;</span> <span class=o>=</span>
    <span class=n>async</span><span class=o>.</span><span class=n>Bind</span><span class=o>(</span><span class=n>a</span><span class=o>,</span> <span class=n>f</span><span class=o>)</span>
  <span class=k>static</span> <span class=k>member</span> <span class=n>map</span> <span class=o>(</span><span class=n>f</span><span class=o>:</span><span class=k>&#39;</span><span class=n>b</span> <span class=o>-&gt;</span> <span class=k>&#39;</span><span class=n>c</span><span class=o>)</span> <span class=o>(</span><span class=n>a</span><span class=o>:</span><span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span> <span class=o>:</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;</span> <span class=o>=</span>
    <span class=n>async</span><span class=o>.</span><span class=n>Bind</span><span class=o>(</span><span class=n>a</span><span class=o>,</span> <span class=n>f</span> <span class=o>&gt;&gt;</span> <span class=n>async</span><span class=o>.</span><span class=n>Return</span><span class=o>)</span>

<span class=c1>// Don&#39;t worry too much about this yet, we&#39;ll get to it later
</span><span class=c1></span><span class=k>module</span> <span class=nn>AsyncArrow</span> <span class=o>=</span>
  <span class=k>let</span> <span class=nv>mapOut</span> <span class=o>(</span><span class=n>f</span><span class=o>:</span><span class=k>&#39;</span><span class=n>b</span> <span class=o>-&gt;</span> <span class=k>&#39;</span><span class=n>c</span><span class=o>)</span> <span class=o>(</span><span class=n>a</span><span class=o>:</span><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span> <span class=o>:</span> <span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;</span> <span class=o>=</span>
    <span class=n>a</span> <span class=o>&gt;&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>map</span> <span class=n>f</span>

  <span class=k>let</span> <span class=nv>mapOutAsync</span> <span class=o>(</span><span class=n>f</span><span class=o>:</span><span class=k>&#39;</span><span class=n>b</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;)</span> <span class=o>(</span><span class=n>a</span><span class=o>:</span><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span> <span class=o>:</span> <span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;</span> <span class=o>=</span>
    <span class=n>a</span> <span class=o>&gt;&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>bind</span> <span class=n>f</span>

  <span class=k>let</span> <span class=nv>mapIn</span> <span class=o>(</span><span class=n>f</span><span class=o>:</span><span class=k>&#39;</span><span class=n>a2</span> <span class=o>-&gt;</span> <span class=k>&#39;</span><span class=n>a</span><span class=o>)</span> <span class=o>(</span><span class=n>a</span><span class=o>:</span><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span> <span class=o>:</span> <span class=k>&#39;</span><span class=n>a2</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;</span> <span class=o>=</span>
    <span class=n>f</span> <span class=o>&gt;&gt;</span> <span class=n>a</span>

  <span class=k>let</span> <span class=nv>after</span> <span class=o>(</span><span class=n>f</span><span class=o>:</span><span class=k>&#39;</span><span class=n>a</span> <span class=o>*</span> <span class=k>&#39;</span><span class=n>b</span> <span class=o>-&gt;</span> <span class=o>_)</span> <span class=o>(</span><span class=n>g</span><span class=o>:</span><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span> <span class=o>:</span> <span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;</span> <span class=o>=</span>
    <span class=k>fun</span> <span class=n>a</span> <span class=o>-&gt;</span> <span class=n>g</span> <span class=n>a</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>map</span> <span class=o>(</span><span class=k>fun</span> <span class=n>b</span> <span class=o>-&gt;</span> <span class=k>let</span> <span class=nv>_</span> <span class=o>=</span> <span class=n>f</span> <span class=o>(</span><span class=n>a</span><span class=o>,</span><span class=n>b</span><span class=o>)</span> <span class=k>in</span> <span class=n>b</span><span class=o>)</span>
</code></pre></div><hr><h2 id=i-have-a-little-request>I have a little request&mldr;</h2><p>Okay, now that&rsquo;s out of the way, let&rsquo;s write a function that takes a <code>HttpReq</code> and returns an <code>Async&lt;HttpRes></code>.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>makeHttpReq</span> <span class=o>:</span> <span class=n>HttpReq</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=n>HttpRes</span><span class=o>&gt;</span> <span class=o>=</span>
  <span class=k>fun</span> <span class=o>(</span><span class=n>req</span><span class=o>:</span><span class=n>HttpReq</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>async</span> <span class=o>{</span>
    <span class=k>use</span> <span class=n>client</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpClient</span> <span class=bp>()</span>
    <span class=k>return</span><span class=o>!</span> <span class=n>client</span><span class=o>.</span><span class=n>SendAsync</span> <span class=n>req</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span> <span class=o>}</span>
</code></pre></div><p>See the <code>HttpReq -> Async&lt;HttpRes></code> up there? That&rsquo;s an arrow. By the end of this post you&rsquo;ll hopefully be an arrow fan and you&rsquo;ll start seeing the <code>'a -> M&lt;'b></code> pattern everywhere.</p><p>We could have written the function signature with the <code>AsyncArrow</code> type alias to be really obvious that we&rsquo;re returning an arrow.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>makeHttpReq</span> <span class=o>:</span> <span class=n>AsyncArrow</span><span class=o>&lt;</span><span class=n>HttpReq</span><span class=o>,</span> <span class=n>HttpRes</span><span class=o>&gt;</span> <span class=o>=</span> <span class=o>...</span>
</code></pre></div><p>Personally I find <code>HttpReq -> Async&lt;HttpRes></code> easier to read and I use this pattern through the rest of the post.</p><p>Back to our <code>makeHttpRequest</code> function. You can run it simply by applying the input argument, in this case a <code>HttpReq</code>.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>new</span> <span class=n>HttpReq</span> <span class=o>(</span><span class=nn>HttpMethod</span><span class=p>.</span><span class=n>Get</span><span class=o>,</span> <span class=n>giphyTrending</span><span class=o>)</span>
<span class=o>|&gt;</span> <span class=n>makeHttpRequest</span>
<span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>RunSynchronously</span>
</code></pre></div><p>That&rsquo;s nice, it works, but I don&rsquo;t care for anything in the <code>HttpRes</code>, I just want the content. Let&rsquo;s get that as a string next.</p><hr><h2 id=map-out-a-route>Map out a route</h2><p>In our <code>AsyncArrow</code> module above we have a <code>mapOutAsync</code> function that looks like this:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>val</span> <span class=n>mapOutAsync</span> <span class=o>:</span>
  <span class=n>f</span><span class=o>:(</span><span class=k>&#39;</span><span class=n>b</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;)</span> <span class=o>-&gt;</span> <span class=n>a</span><span class=o>:(</span><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span> <span class=o>-&gt;</span> <span class=o>(</span><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;)</span>
</code></pre></div><p>Let&rsquo;s follow the types and see how it works.</p><p>If we put our input <code>a</code> type and the output type next to each other it becomes obvious how to make it work.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;</span> <span class=c1>// this is the input &#39;a&#39;
</span><span class=c1></span><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>c</span><span class=o>&gt;</span> <span class=c1>// this is our output
</span></code></pre></div><p>We can clearly see that a solution is to require a function <code>'b -> 'c</code>, and that&rsquo;s exactly what the <code>mapOut</code> function is defined as in the <code>AsyncArrow</code> module.</p><p>Another solution is to require a function <code>'b -> Async&lt;'c></code>, which is what we need here, and it lines up perfectly with the signature for <code>mapOutAsync</code>.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>arrow</span> <span class=o>=</span>
    <span class=n>makeHttpRequest</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapOutAsync</span> <span class=o>(</span><span class=k>fun</span> <span class=n>res</span> <span class=o>-&gt;</span>
        <span class=n>res</span><span class=o>.</span><span class=n>Content</span><span class=o>.</span><span class=n>ReadAsStringAsync</span> <span class=bp>()</span>
        <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span><span class=o>)</span>
</code></pre></div><p>And we call it simply by giving it a <code>Req</code></p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>new</span> <span class=n>HttpReq</span> <span class=o>(</span><span class=nn>HttpMethod</span><span class=p>.</span><span class=n>Get</span><span class=o>,</span> <span class=n>giphyTrending</span><span class=o>)</span>
<span class=o>|&gt;</span> <span class=n>arrow</span>
<span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>RunSynchronously</span>
</code></pre></div><p>You can call it the same way as we did above.</p><hr><h2 id=once-we-accept-our-limits-we-go-beyond-them>Once we accept our limits, we go beyond them</h2><p><strong>- Albert Einstein</strong></p><p>Let&rsquo;s be good citizens and add in an <code>Accept</code> header.</p><p>What we want to do here is create a new arrow that takes an <code>HttpReq</code>, adds the <code>Accept</code> header to the request and then applies the request to the original arrow, which will return an <code>Async&lt;HttpRes></code>.</p><p>The function that does this is called <code>mapIn</code>&mldr;</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>val</span> <span class=n>mapIn</span> <span class=o>:</span> <span class=n>f</span><span class=o>:(</span><span class=k>&#39;</span><span class=n>a2</span> <span class=o>-&gt;</span> <span class=k>&#39;</span><span class=n>a</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>a</span><span class=o>:(</span><span class=k>&#39;</span><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span> <span class=o>-&gt;</span> <span class=o>(</span><span class=k>&#39;</span><span class=n>a2</span> <span class=o>-&gt;</span> <span class=n>Async</span><span class=o>&lt;</span><span class=k>&#39;</span><span class=n>b</span><span class=o>&gt;)</span>
</code></pre></div><p>&mldr;and here&rsquo;s how you use it.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>arrow</span> <span class=o>=</span>
    <span class=n>makeHttpRequest</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapOutAsync</span> <span class=o>(</span><span class=k>fun</span> <span class=n>res</span> <span class=o>-&gt;</span>
        <span class=n>res</span><span class=o>.</span><span class=n>Content</span><span class=o>.</span><span class=n>ReadAsStringAsync</span> <span class=bp>()</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>req</span><span class=o>:</span><span class=n>HttpReq</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=n>req</span><span class=o>.</span><span class=n>Headers</span><span class=o>.</span><span class=n>Add</span> <span class=o>(</span><span class=s>&#34;Accept&#34;</span><span class=o>,</span> <span class=s>&#34;application/json&#34;</span><span class=o>)</span>
        <span class=n>req</span><span class=o>)</span>
</code></pre></div><hr><h2 id=may-your-inputs-be-forever-changing>May your inputs be forever changing</h2><p>Let&rsquo;s do another <code>mapIn</code>, but this time change it&rsquo;s type. It&rsquo;s now time to get rid of that pesky <code>HttpReq</code>.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>arrow</span> <span class=o>=</span>
    <span class=n>makeHttpRequest</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapOutAsync</span> <span class=o>(</span><span class=k>fun</span> <span class=n>res</span> <span class=o>-&gt;</span>
        <span class=n>res</span><span class=o>.</span><span class=n>Content</span><span class=o>.</span><span class=n>ReadAsStringAsync</span> <span class=bp>()</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>req</span><span class=o>:</span><span class=n>HttpReq</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=n>req</span><span class=o>.</span><span class=n>Headers</span><span class=o>.</span><span class=n>Add</span> <span class=o>(</span><span class=s>&#34;Accept&#34;</span><span class=o>,</span> <span class=s>&#34;application/json&#34;</span><span class=o>)</span>
        <span class=n>req</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>url</span><span class=o>:</span><span class=kt>string</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=k>new</span> <span class=n>HttpRequestMessage</span><span class=o>(</span><span class=nn>HttpMethod</span><span class=p>.</span><span class=n>Get</span><span class=o>,</span> <span class=n>url</span><span class=o>))</span>
</code></pre></div><p>We call this by passing in a string url.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=n>giphyTrending</span>
<span class=o>|&gt;</span> <span class=n>arrow</span>
<span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>RunSynchronously</span>
</code></pre></div><p>We&rsquo;re getting errors about authentication, let&rsquo;s add the api key to the request with another <code>mapIn</code>.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>arrow</span> <span class=o>=</span>
    <span class=n>makeHttpRequest</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapOutAsync</span> <span class=o>(</span><span class=k>fun</span> <span class=n>res</span> <span class=o>-&gt;</span>
        <span class=n>res</span><span class=o>.</span><span class=n>Content</span><span class=o>.</span><span class=n>ReadAsStringAsync</span> <span class=bp>()</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>req</span><span class=o>:</span><span class=n>HttpReq</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=n>req</span><span class=o>.</span><span class=n>Headers</span><span class=o>.</span><span class=n>Add</span> <span class=o>(</span><span class=s>&#34;Accept&#34;</span><span class=o>,</span> <span class=s>&#34;application/json&#34;</span><span class=o>)</span>
        <span class=n>req</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>url</span><span class=o>:</span><span class=kt>string</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=k>new</span> <span class=n>HttpRequestMessage</span><span class=o>(</span><span class=nn>HttpMethod</span><span class=p>.</span><span class=n>Get</span><span class=o>,</span> <span class=n>url</span><span class=o>))</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=n>url</span> <span class=o>-&gt;</span> <span class=n>url</span> <span class=o>+</span> <span class=s>&#34;?api_key=dc6zaTOxFJmzC&#34;</span><span class=o>)</span>
</code></pre></div><p>Run that and you&rsquo;ll get a lovely json response.</p><hr><h2 id=the-home-stretch>The home stretch</h2><p>Let&rsquo;s get the first url from the list using <code>mapOut</code>.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>arrow</span> <span class=o>=</span>
    <span class=n>makeHttpRequest</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapOutAsync</span> <span class=o>(</span><span class=k>fun</span> <span class=n>res</span> <span class=o>-&gt;</span>
        <span class=n>res</span><span class=o>.</span><span class=n>Content</span><span class=o>.</span><span class=n>ReadAsStringAsync</span> <span class=bp>()</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>req</span><span class=o>:</span><span class=n>HttpReq</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=n>req</span><span class=o>.</span><span class=n>Headers</span><span class=o>.</span><span class=n>Add</span> <span class=o>(</span><span class=s>&#34;Accept&#34;</span><span class=o>,</span> <span class=s>&#34;application/json&#34;</span><span class=o>)</span>
        <span class=n>req</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>url</span><span class=o>:</span><span class=kt>string</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=k>new</span> <span class=n>HttpRequestMessage</span><span class=o>(</span><span class=nn>HttpMethod</span><span class=p>.</span><span class=n>Get</span><span class=o>,</span> <span class=n>url</span><span class=o>))</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=n>url</span> <span class=o>-&gt;</span> <span class=n>url</span> <span class=o>+</span> <span class=s>&#34;?api_key=dc6zaTOxFJmzC&#34;</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapOut</span> <span class=o>(</span><span class=k>fun</span> <span class=n>res</span> <span class=o>-&gt;</span>
        <span class=nn>Regex</span><span class=p>.</span><span class=n>Match</span><span class=o>(</span><span class=n>res</span><span class=o>,</span> <span class=s>&#34;</span><span class=se>\&#34;</span><span class=s>url</span><span class=se>\&#34;</span><span class=s>:</span><span class=se>\&#34;</span><span class=s>(.+?)</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=o>).</span><span class=n>Groups</span><span class=o>.[</span><span class=n>1</span><span class=o>].</span><span class=n>Value</span><span class=o>.</span><span class=n>Replace</span> <span class=o>(</span><span class=s>&#34;</span><span class=se>\\</span><span class=s>&#34;</span><span class=o>,</span> <span class=s>&#34;&#34;</span><span class=o>))</span>
</code></pre></div><p>Sorry about the regex, I didn&rsquo;t want to add a dependency on a Json parser.</p><hr><h2 id=after-all-is-said-and-done>After all is said and done&mldr;</h2><p>Let&rsquo;s open the gif in your browser.</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>arrow</span> <span class=o>=</span>
    <span class=n>makeHttpRequest</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapOutAsync</span> <span class=o>(</span><span class=k>fun</span> <span class=n>res</span> <span class=o>-&gt;</span>
        <span class=n>res</span><span class=o>.</span><span class=n>Content</span><span class=o>.</span><span class=n>ReadAsStringAsync</span> <span class=bp>()</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>req</span><span class=o>:</span><span class=n>HttpReq</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=n>req</span><span class=o>.</span><span class=n>Headers</span><span class=o>.</span><span class=n>Add</span> <span class=o>(</span><span class=s>&#34;Accept&#34;</span><span class=o>,</span> <span class=s>&#34;application/json&#34;</span><span class=o>)</span>
        <span class=n>req</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>url</span><span class=o>:</span><span class=kt>string</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=k>new</span> <span class=n>HttpRequestMessage</span><span class=o>(</span><span class=nn>HttpMethod</span><span class=p>.</span><span class=n>Get</span><span class=o>,</span> <span class=n>url</span><span class=o>))</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapIn</span> <span class=o>(</span><span class=k>fun</span> <span class=n>url</span> <span class=o>-&gt;</span> <span class=n>url</span> <span class=o>+</span> <span class=s>&#34;?api_key=dc6zaTOxFJmzC&#34;</span><span class=o>)</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>mapOut</span> <span class=o>(</span><span class=k>fun</span> <span class=n>res</span> <span class=o>-&gt;</span>
        <span class=nn>Regex</span><span class=p>.</span><span class=n>Match</span><span class=o>(</span><span class=n>res</span><span class=o>,</span> <span class=s>&#34;</span><span class=se>\&#34;</span><span class=s>url</span><span class=se>\&#34;</span><span class=s>:</span><span class=se>\&#34;</span><span class=s>(.+?)</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=o>).</span><span class=n>Groups</span><span class=o>.[</span><span class=n>1</span><span class=o>].</span><span class=n>Value</span><span class=o>.</span><span class=n>Replace</span> <span class=o>(</span><span class=s>&#34;</span><span class=se>\\</span><span class=s>&#34;</span><span class=o>,</span> <span class=s>&#34;&#34;</span><span class=o>))</span>
    <span class=o>|&gt;</span> <span class=nn>AsyncArrow</span><span class=p>.</span><span class=n>after</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>input</span><span class=o>,</span> <span class=n>output</span><span class=o>)</span> <span class=o>-&gt;</span>
        <span class=nn>Process</span><span class=p>.</span><span class=n>Start</span> <span class=n>output</span><span class=o>)</span>
</code></pre></div><p>What is really nice about the <code>after</code> function is that you get the <code>output</code>, but also the <code>input</code> that caused the <code>output</code>. Very helpful for logging.</p><hr><h2 id=next-steps>Next steps</h2><h3 id=conferences>Conferences</h3><p>I&rsquo;ll be speaking about the <code>AsyncArrow</code> at <a href=http://ndc-london.com/>NDC London</a>, 16 - 20 January 2017, so come and listen and say hi.</p><h3 id=projects>Projects</h3><p><a href=https://github.com/twitter/finagle>Finagle</a> by Twitter<br>While different to our use in this post, the <code>'Req -> Async&lt;'Res></code> signature implements a server.</p><p>Jet is planning to open source our <code>AsyncArrow</code> module. We&rsquo;re also discussing naming and there&rsquo;s a chance it will be released as <code>AsyncFunc</code>, so look out for that too.</p><h3 id=papers>Papers</h3><p><a href=https://monkey.org/~marius/funsrv.pdf>Your Server as a Function</a> by Marius Eriksen<br><a href=http://www.cse.chalmers.se/~rjmh/afp-arrows.pdf>Programming with Arrows</a> by John Hughes<br><a href=http://www.cse.chalmers.se/~rjmh/Papers/arrows.pdf>Generalising Monads to Arrows</a> by John Hughes (referenced in the post above)</p><h3 id=people>People</h3><p>I was introduced to arrows by <a href=https://twitter.com/eulerfx>Leo Gorodinski</a>, and he said you could reach out to him.<br>Feel free to <a href=https://twitter.com/troykershaw>reach out to me as well</a>.</p><hr><p>Fun, huh?</p></div><div class=paginator><a class=link href=https://www.troykershaw.com/post/getting-started-with-signalr-fsharp-owin/>← prev</a>
<a class=link href=https://www.troykershaw.com/post/async-arrow-the-talk/>next →</a></div></main><footer id=footer><div><span>© 2014</span> - <span>2020</span></div><div class=footnote><span><a class=link href=https://github.com/troykershaw>GitHub</a> | <a class=link href=https://www.linkedin.com/in/troykershaw>LinkedIn</a> | <a class=link href=/index.xml>RSS</a></span></div></footer></div></body></html>