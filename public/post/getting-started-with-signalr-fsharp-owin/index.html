<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=author content="Troy"><meta name=description content="SignalR allows us to easily push messages back and forth between a client (usually a website) and server using websockets. All of the pain of creating a connection, keeping the connection alive, reconnecting, serialising and deserialising messages, plus lots, lots more is taken care of for you.
In this post we&rsquo;re going to create a SignalR server and push some messages back and forth from a website. You can see the completed source at github."><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Getting Started with SignalR using F# and OWIN"><meta name=twitter:description content="SignalR allows us to easily push messages back and forth between a client (usually a website) and server using websockets. All of the pain of creating a connection, keeping the connection alive, reconnecting, serialising and deserialising messages, plus lots, lots more is taken care of for you.
In this post we&rsquo;re going to create a SignalR server and push some messages back and forth from a website. You can see the completed source at github."><link rel=canonical href=https://www.troykershaw.com/post/getting-started-with-signalr-fsharp-owin/><link media=screen rel=stylesheet href=https://www.troykershaw.com/css/common.css><link media=screen rel=stylesheet href=https://www.troykershaw.com/css/content.css><link media=screen rel=stylesheet href=https://www.troykershaw.com/css/highlight.css><title>Getting Started with SignalR using F# and OWIN - Troy Kershaw's Website</title><script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\[\[','\]\]']],processEscapes:true,processEnvironments:true,},options:{skipHtmlTags:['script','noscript','style','textarea','pre'],}};</script><script async defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js id=MathJax-script></script><link rel=stylesheet href=https://www.troykershaw.com/css/single.css></head><body><div id=wrapper><header id=header><h1><a href=https://www.troykershaw.com/>Troy Kershaw's Website</a></h1><nav><span class=nav-bar-item><a class=link href=/>Posts</a></span>
<span class=nav-bar-item><a class=link href=/about/>About</a></span></nav></header><main id=main class=post><h1>Getting Started with SignalR using F# and OWIN</h1><div class=content><p><a href=http://signalr.net/>SignalR</a> allows us to easily push messages back and forth between a client (usually a website) and server using websockets. All of the pain of creating a connection, keeping the connection alive, reconnecting, serialising and deserialising messages, plus lots, lots more is taken care of for you.</p><p>In this post we&rsquo;re going to create a SignalR server and push some messages back and forth from a website. You can see the completed source at <a href=https://github.com/troykershaw/signalr-fsharp-getting-started>github.com/troykershaw/signalr-fsharp-getting-started</a>.</p><p>Note: This will probably only run on Windows.</p><h2 id=get-the-project-set-up>Get the project set up</h2><ul><li>Create a new console application. I chose to use .NET 4.6.1, but anything in the 4.x range should work.</li></ul><h3 id=hello-paket>Hello, Paket</h3><p>We&rsquo;re going to use Paket to download and manage our dependencies. Compared to nuget <a href=https://fsprojects.github.io/Paket/>Paket</a> requires a little effort to set up for a new project but it&rsquo;s totally worth it. Here&rsquo;s how to do it, basically pulled straight from Paket&rsquo;s <a href=https://fsprojects.github.io/Paket/getting-started.html>Getting Started</a> page</p><ul><li>Open a command window (because it&rsquo;s hard to create a folder with a dot in front of it from Windows Explorer)</li><li>Create a <code>.paket</code> folder in the root of your solution (<code>mkdir .paket</code>).</li><li>Download the latest <a href=https://github.com/fsprojects/Paket/releases/latest>paket.bootstrapper.exe</a> into that folder.</li><li>Run .paket/paket.bootstrapper.exe. This will download the latest paket.exe.</li><li>Commit .paket/paket.bootstrapper.exe into your repo and add .paket/paket.exe to your .gitignore file.</li><li>Create a <code>paket.dependencies</code> file in your project&rsquo;s root and paste in the following:</li></ul><pre><code>source https://nuget.org/api/v2

nuget Microsoft.AspNet.SignalR.SelfHost
nuget Microsoft.Owin.Cors
nuget Microsoft.Owin.StaticFiles
nuget FSharp.Interop.Dynamic
</code></pre><ul><li>In your project create a file named <code>paket.references</code> and paste in the following:</li></ul><pre><code>Microsoft.AspNet.SignalR.SelfHost
Microsoft.Owin.Cors
Microsoft.Owin.StaticFiles
FSharp.Interop.Dynamic
</code></pre><ul><li>Run the command <code>.paket\paket.exe install</code> to install all the dependencies.</li></ul><p>Now you&rsquo;ve got everything you need for the rest of this blog post.</p><h2 id=lets-get-the-server-running>Let&rsquo;s get the server running</h2><p>SignalR is part of the ASP.NET family and runs nicely in a standalone <a href=http://owin.org/>OWIN</a> server, so let&rsquo;s do that.</p><ul><li>Create a new file called <code>Signalr.fs</code> and put it above `Program.fs.</li><li>Here&rsquo;s all we need to get the server running, so paste it in</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>module</span> <span class=nn>Signalr</span>

<span class=k>open</span> <span class=nn>Owin</span>
<span class=k>open</span> <span class=nn>FSharp.Interop.Dynamic</span>
<span class=k>open</span> <span class=nn>Microsoft.AspNet.SignalR</span>
<span class=k>open</span> <span class=nn>Microsoft.Owin.Hosting</span>
<span class=k>open</span> <span class=nn>Microsoft.Owin.Cors</span>
<span class=k>open</span> <span class=nn>Microsoft.AspNet.SignalR.Hubs</span>

<span class=k>type</span> <span class=nc>Server</span> <span class=o>(</span><span class=n>host</span><span class=o>:</span><span class=kt>string</span><span class=o>)</span> <span class=o>=</span>
    <span class=k>let</span> <span class=nv>startup</span> <span class=o>(</span><span class=n>a</span><span class=o>:</span><span class=n>IAppBuilder</span><span class=o>)</span> <span class=o>=</span>
        <span class=n>a</span><span class=o>.</span><span class=n>UseCors</span><span class=o>(</span><span class=nn>CorsOptions</span><span class=p>.</span><span class=n>AllowAll</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
        <span class=n>a</span><span class=o>.</span><span class=n>MapSignalR</span><span class=bp>()</span> <span class=o>|&gt;</span> <span class=n>ignore</span>

    <span class=k>do</span>
        <span class=nn>WebApp</span><span class=p>.</span><span class=n>Start</span><span class=o>(</span><span class=n>host</span><span class=o>,</span> <span class=n>startup</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
        <span class=n>printfn</span> <span class=s>&#34;Signalr server running on %s&#34;</span> <span class=n>host</span>
</code></pre></div><p>But of course that won&rsquo;t do anything yet.</p><ul><li>Open <code>Program.fs</code> and make it look like:</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=o>[&lt;</span><span class=n>EntryPoint</span><span class=o>&gt;]</span>
<span class=k>let</span> <span class=nv>main</span> <span class=o>_</span> <span class=o>=</span>
    <span class=k>let</span> <span class=nv>signalr</span> <span class=o>=</span> <span class=nn>Signalr</span><span class=p>.</span><span class=n>Server</span> <span class=s>&#34;http://localhost:7777&#34;</span>

    <span class=nn>System</span><span class=p>.</span><span class=nn>Console</span><span class=p>.</span><span class=n>ReadLine</span><span class=bp>()</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
    <span class=n>0</span>
</code></pre></div><p>Now you can run it, and get a loose confirmation that it worked because it printed something to the Console window.</p><p>What&rsquo;s happening is <code>Program.fs</code> creates an instance of our SignalR server and then doesn&rsquo;t exit because it&rsquo;s waiting for you to press <code>Enter</code>. <code>Signalr.fs</code> creates a <code>startup</code> function that enables CORS and enables Signalr, then we start the OWIN server using that configuration.</p><h2 id=send-some-messages-to-a-web-page>Send some messages to a web page</h2><p>To actually be useful let&rsquo;s send a message to a web page. We, of course, first need to create a web page and some way of serving that page. We <em>could</em> just tack it on to our current SignalR server but because OWIN servers are so easy to write let&rsquo;s create a new one.</p><ul><li>Create a new file called <code>Static.fs</code>, put it above <code>Program.fs</code> and paste in the following:</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>module</span> <span class=nn>Static</span>

<span class=k>open</span> <span class=nn>Owin</span>
<span class=k>open</span> <span class=nn>Microsoft.Owin.Hosting</span>

<span class=k>type</span> <span class=nc>Server</span> <span class=o>(</span><span class=n>host</span><span class=o>:</span><span class=kt>string</span><span class=o>)</span> <span class=o>=</span>
    <span class=k>let</span> <span class=nv>startup</span> <span class=o>(</span><span class=n>a</span><span class=o>:</span><span class=n>IAppBuilder</span><span class=o>)</span> <span class=o>=</span>
        <span class=n>a</span><span class=o>.</span><span class=n>UseFileServer</span><span class=o>(</span><span class=k>true</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>

    <span class=k>do</span>
        <span class=nn>WebApp</span><span class=p>.</span><span class=n>Start</span><span class=o>(</span><span class=n>host</span><span class=o>,</span> <span class=n>startup</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
        <span class=n>printfn</span> <span class=s>&#34;Static server running on %s&#34;</span> <span class=n>host</span>
</code></pre></div><p>We now have a server that serves static files. Let&rsquo;s start it.</p><ul><li>In <code>Program.fs</code> add <code>let staticServer = Static.Server "http://localhost:8777"</code> after the SignalR server.</li><li>Create an <code>index.html</code> page and set the property <strong>Copy to Output Directory</strong> to <strong>Copy always</strong>.</li><li>Also, paste in the following:</li></ul><div class=highlight><pre class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>pre</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;message&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>pre</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.2.0.min.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://localhost:7777/signalr/hubs&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>

    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/javascript&#34;</span><span class=p>&gt;</span>
        <span class=nx>$</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
            <span class=c1>// set our hub url
</span><span class=c1></span>            <span class=nx>$</span><span class=p>.</span><span class=nx>connection</span><span class=p>.</span><span class=nx>hub</span><span class=p>.</span><span class=nx>url</span> <span class=o>=</span> <span class=s2>&#34;http://localhost:7777/signalr&#34;</span><span class=p>;</span>

            <span class=c1>// get our hub
</span><span class=c1></span>            <span class=kd>var</span> <span class=nx>hub</span> <span class=o>=</span> <span class=nx>$</span><span class=p>.</span><span class=nx>connection</span><span class=p>.</span><span class=nx>myFirstHub</span><span class=p>;</span>

            <span class=c1>// function that the server will call
</span><span class=c1></span>            <span class=nx>hub</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>messageToTheClient</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>{</span>
                <span class=kd>var</span> <span class=nx>json</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>

                <span class=c1>// add the message to the page
</span><span class=c1></span>                <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#message&#39;</span><span class=p>).</span><span class=nx>text</span><span class=p>(</span><span class=nx>json</span><span class=p>);</span>
            <span class=p>}</span>

            <span class=c1>// connect to the server
</span><span class=c1></span>            <span class=nx>$</span><span class=p>.</span><span class=nx>connection</span><span class=p>.</span><span class=nx>hub</span><span class=p>.</span><span class=nx>start</span><span class=p>()</span>
                <span class=p>.</span><span class=nx>done</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
                    <span class=c1>// we&#39;ve connected, so let&#39;s send a message!
</span><span class=c1></span>                    <span class=nx>hub</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nx>messageToTheServer</span><span class=p>(</span><span class=s2>&#34;Hello from the client!&#34;</span><span class=p>);</span>
                <span class=p>});</span>
        <span class=p>});</span>
    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p>When you go to <a href=http://localhost:8777/index.html>http://localhost:8777/index.html</a> you&rsquo;ll get a blank web page! Yay!</p><h2 id=myfirsthub>MyFirstHub</h2><p>The SignalR client and server relationship communicates over &lsquo;hubs&rsquo;, so let&rsquo;s create one of those.</p><ul><li>Within the <code>Signalr.fs</code> file and above the <code>Server</code> class put this:</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=o>[&lt;</span><span class=n>HubName</span><span class=o>(</span><span class=s>&#34;myFirstHub&#34;</span><span class=o>)&gt;]</span>
<span class=k>type</span> <span class=nc>MyFirstHub</span> <span class=bp>()</span> <span class=o>=</span>
    <span class=k>inherit</span> <span class=n>Hub</span> <span class=bp>()</span>

    <span class=k>member</span> <span class=n>x</span><span class=p>.</span><span class=nf>MessageToTheServer</span> <span class=n>message</span> <span class=o>=</span>
        <span class=n>printfn</span> <span class=s>&#34;Someone sent us a message! - %s&#34;</span> <span class=n>message</span>
</code></pre></div><p>The <code>MessageToTheServer</code> method is what SignalR clients call. If you run our app now and refresh the web page the web page will send the message &ldquo;Hello from the client!&rdquo; to our server which you can confirm is happening because it prints it to the console.</p><h2 id=sending-messages>Sending messages</h2><p>Sending messages to our clients is quite easy, we don&rsquo;t even need to update our hub. What we will do, however, is create a method that consumers of our server can call to send a message.</p><ul><li>Above the <code>do</code> in the SignalR <code>Server</code> class put:</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>clients</span> <span class=o>=</span> <span class=nn>GlobalHost</span><span class=p>.</span><span class=nn>ConnectionManager</span><span class=p>.</span><span class=n>GetHubContext</span><span class=o>&lt;</span><span class=n>MyFirstHub</span><span class=o>&gt;</span><span class=bp>()</span><span class=o>.</span><span class=n>Clients</span>
</code></pre></div><p>This gives us an easy way to get to our clients.</p><ul><li>Right at the bottom of the class put:</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>member</span> <span class=n>x</span><span class=p>.</span><span class=nf>Send</span> <span class=n>message</span> <span class=o>=</span> <span class=n>clients</span><span class=o>.</span><span class=n>All</span><span class=o>?</span><span class=n>messageToTheClient</span> <span class=n>message</span>
</code></pre></div><p>In the <code>Send</code> method we simply push the message to all clients (<code>clients.All</code>) and call the function <code>messageToTheClient</code> on the client.</p><p>Let&rsquo;s call <code>signalr.Send</code> in <code>Program.fs</code>. Actually, let&rsquo;s send a message every second.</p><ul><li>Replace <code>System.Console.ReadLine() |> ignore</code> with</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>rec</span> <span class=n>loop</span> <span class=n>message</span> <span class=o>=</span>
    <span class=n>async</span> <span class=o>{</span>
        <span class=n>signalr</span><span class=o>.</span><span class=n>Send</span> <span class=n>message</span>
        <span class=k>do</span><span class=o>!</span> <span class=nn>Async</span><span class=p>.</span><span class=n>Sleep</span> <span class=n>1000</span>
        <span class=k>return</span><span class=o>!</span> <span class=n>loop</span> <span class=n>message</span>
    <span class=o>}</span>

<span class=s>&#34;The server says hello!&#34;</span>
<span class=o>|&gt;</span> <span class=n>loop</span>
<span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>RunSynchronously</span>
</code></pre></div><p>Run our app, refresh the page and the server message appears on the screen. Magic!</p><h2 id=debugging-in-chrome>Debugging in Chrome</h2><p>It&rsquo;s easy to see what&rsquo;s being sent to the client from the server in Chrome.</p><p>Go to our webpage, open dev tools (<code>Ctrl + Shift + I</code>), select the &lsquo;Network&rsquo; tab and select the &lsquo;WS&rsquo; filter.</p><p>Reload the page and you&rsquo;ll see something pop up under &lsquo;Name&rsquo; that reads similar to &lsquo;connect?transport=webSockets&clientProtocol=1.5&connectionToken=&mldr;&rsquo;. Select it and then press &lsquo;Frames&rsquo; just to the right of it.</p><p>Sure enough, at the top of the list we see the message the client sent and every second after that we see a new message from the server. The <code>{}</code> messages are a 10 second heart beat.</p><h2 id=sending-something-a-little-more-interesting>Sending something a little more interesting</h2><p>Sending a string is fun but there&rsquo;s not a lot we can do with that. Let&rsquo;s send something a little more complex.</p><p>We&rsquo;ve had too much excitement up until now so I&rsquo;ll bring the mood down a bit by creating a boring <code>Customer</code> type.</p><ul><li>Create a new file above all the others called <code>Customer.fs</code> and enter the following</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>module</span> <span class=nn>Customer</span>

<span class=k>type</span> <span class=nc>Customer</span> <span class=o>=</span>
    <span class=o>{</span>
        <span class=n>Name</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>Phone</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>Email</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>Address</span> <span class=o>:</span> <span class=n>Address</span>
    <span class=o>}</span>

<span class=ow>and</span> <span class=n>Address</span> <span class=o>=</span>
    <span class=o>{</span>
        <span class=n>Street</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>Suburb</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>City</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>ZipCode</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>Planet</span> <span class=o>:</span> <span class=kt>string</span>
    <span class=o>}</span>
</code></pre></div><ul><li>In <code>Program.fs</code> put an <code>open Customer</code> at the top of the file and replace the current message we&rsquo;re sending (&ldquo;The server says hello!") with the following:</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=o>{</span>
    <span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;Philip J. Fry&#34;</span>
    <span class=n>Phone</span> <span class=o>=</span> <span class=s>&#34;201 289 654&#34;</span>
    <span class=n>Email</span> <span class=o>=</span> <span class=s>&#34;fry@planetexpress.com&#34;</span>
    <span class=n>Address</span> <span class=o>=</span>
        <span class=o>{</span>
            <span class=n>Street</span> <span class=o>=</span> <span class=s>&#34;Robot Arms Apartments, Apt 00100100&#34;</span>
            <span class=n>Suburb</span> <span class=o>=</span> <span class=s>&#34;Manhattan&#34;</span>
            <span class=n>City</span> <span class=o>=</span> <span class=s>&#34;New New York&#34;</span>
            <span class=n>ZipCode</span> <span class=o>=</span> <span class=s>&#34;10007&#34;</span>
            <span class=n>Planet</span> <span class=o>=</span> <span class=s>&#34;Earth&#34;</span>
        <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>Now when we run the app our web page gets the customer message as nice looking json:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;Name&#34;</span><span class=p>:</span> <span class=s2>&#34;Philip J. Fry&#34;</span><span class=p>,</span>
  <span class=nt>&#34;Phone&#34;</span><span class=p>:</span> <span class=s2>&#34;201 289 654&#34;</span><span class=p>,</span>
  <span class=nt>&#34;Email&#34;</span><span class=p>:</span> <span class=s2>&#34;fry@planetexpress.com&#34;</span><span class=p>,</span>
  <span class=nt>&#34;Address&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;Street&#34;</span><span class=p>:</span> <span class=s2>&#34;Robot Arms Apartments, Apt 00100100&#34;</span><span class=p>,</span>
    <span class=nt>&#34;Suburb&#34;</span><span class=p>:</span> <span class=s2>&#34;Manhattan&#34;</span><span class=p>,</span>
    <span class=nt>&#34;City&#34;</span><span class=p>:</span> <span class=s2>&#34;New New York&#34;</span><span class=p>,</span>
    <span class=nt>&#34;ZipCode&#34;</span><span class=p>:</span> <span class=s2>&#34;10007&#34;</span><span class=p>,</span>
    <span class=nt>&#34;Planet&#34;</span><span class=p>:</span> <span class=s2>&#34;Earth&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h2 id=sending-f-things>Sending F# things</h2><p>What happens when we send F# specific things though?</p><ul><li>Update the <code>Customer</code> module to use options and those nice <a href=http://fsharpforfunandprofit.com/ddd/>single option discriminated unions that Scott Wlaschin is harping on about</a></li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>module</span> <span class=nn>Customer</span>

<span class=k>type</span> <span class=nc>Customer</span> <span class=o>=</span>
    <span class=o>{</span>
        <span class=n>Name</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>Phone</span> <span class=o>:</span> <span class=n>Phone</span> <span class=n>option</span>
        <span class=n>Email</span> <span class=o>:</span> <span class=n>Email</span> <span class=n>option</span>
        <span class=n>Address</span> <span class=o>:</span> <span class=n>Address</span> <span class=n>option</span>
    <span class=o>}</span>

<span class=ow>and</span> <span class=n>Phone</span> <span class=o>=</span> <span class=n>Phone</span> <span class=k>of</span> <span class=kt>string</span>

<span class=ow>and</span> <span class=n>Email</span> <span class=o>=</span> <span class=n>Email</span> <span class=k>of</span> <span class=kt>string</span>

<span class=ow>and</span> <span class=n>Address</span> <span class=o>=</span>
    <span class=o>{</span>
        <span class=n>Street</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>Suburb</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>City</span> <span class=o>:</span> <span class=kt>string</span>
        <span class=n>ZipCode</span> <span class=o>:</span> <span class=n>ZipCode</span>
        <span class=n>Planet</span> <span class=o>:</span> <span class=kt>string</span>
    <span class=o>}</span>

<span class=ow>and</span> <span class=n>ZipCode</span> <span class=o>=</span> <span class=n>ZipCode</span> <span class=k>of</span> <span class=kt>string</span>
</code></pre></div><ul><li>Update the message we&rsquo;re sending in <code>Program.fs</code> to:</li></ul><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=o>{</span>
    <span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;Philip J. Fry&#34;</span>
    <span class=n>Phone</span> <span class=o>=</span> <span class=n>Phone</span> <span class=s>&#34;201 289 654&#34;</span> <span class=o>|&gt;</span> <span class=n>Some</span>
    <span class=n>Email</span> <span class=o>=</span> <span class=n>Email</span> <span class=s>&#34;fry@planetexpress.com&#34;</span> <span class=o>|&gt;</span> <span class=n>Some</span>
    <span class=n>Address</span> <span class=o>=</span>
        <span class=o>{</span>
            <span class=n>Street</span> <span class=o>=</span> <span class=s>&#34;Robot Arms Apartments, Apt 00100100&#34;</span>
            <span class=n>Suburb</span> <span class=o>=</span> <span class=s>&#34;Manhattan&#34;</span>
            <span class=n>City</span> <span class=o>=</span> <span class=s>&#34;New New York&#34;</span>
            <span class=n>ZipCode</span> <span class=o>=</span> <span class=n>ZipCode</span> <span class=s>&#34;10007&#34;</span>
            <span class=n>Planet</span> <span class=o>=</span> <span class=s>&#34;Earth&#34;</span>
        <span class=o>}</span> <span class=o>|&gt;</span> <span class=n>Some</span>
<span class=o>}</span>
</code></pre></div><p>Run everything again.</p><p>It worked! Although the json is really, really ugly.</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;Name&#34;</span><span class=p>:</span> <span class=s2>&#34;Philip J. Fry&#34;</span><span class=p>,</span>
  <span class=nt>&#34;Phone&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;Case&#34;</span><span class=p>:</span> <span class=s2>&#34;Some&#34;</span><span class=p>,</span>
    <span class=nt>&#34;Fields&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=p>{</span>
        <span class=nt>&#34;Case&#34;</span><span class=p>:</span> <span class=s2>&#34;Phone&#34;</span><span class=p>,</span>
        <span class=nt>&#34;Fields&#34;</span><span class=p>:</span> <span class=p>[</span>
          <span class=s2>&#34;201 289 654&#34;</span>
        <span class=p>]</span>
      <span class=p>}</span>
    <span class=p>]</span>
  <span class=p>},</span>
  <span class=nt>&#34;Email&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;Case&#34;</span><span class=p>:</span> <span class=s2>&#34;Some&#34;</span><span class=p>,</span>
    <span class=nt>&#34;Fields&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=p>{</span>
        <span class=nt>&#34;Case&#34;</span><span class=p>:</span> <span class=s2>&#34;Email&#34;</span><span class=p>,</span>
        <span class=nt>&#34;Fields&#34;</span><span class=p>:</span> <span class=p>[</span>
          <span class=s2>&#34;fry@planetexpress.com&#34;</span>
        <span class=p>]</span>
      <span class=p>}</span>
    <span class=p>]</span>
  <span class=p>},</span>
  <span class=nt>&#34;Address&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;Case&#34;</span><span class=p>:</span> <span class=s2>&#34;Some&#34;</span><span class=p>,</span>
    <span class=nt>&#34;Fields&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=p>{</span>
        <span class=nt>&#34;Street&#34;</span><span class=p>:</span> <span class=s2>&#34;Robot Arms Apartments, Apt 00100100&#34;</span><span class=p>,</span>
        <span class=nt>&#34;Suburb&#34;</span><span class=p>:</span> <span class=s2>&#34;Manhattan&#34;</span><span class=p>,</span>
        <span class=nt>&#34;City&#34;</span><span class=p>:</span> <span class=s2>&#34;New New York&#34;</span><span class=p>,</span>
        <span class=nt>&#34;ZipCode&#34;</span><span class=p>:</span> <span class=p>{</span>
          <span class=nt>&#34;Case&#34;</span><span class=p>:</span> <span class=s2>&#34;ZipCode&#34;</span><span class=p>,</span>
          <span class=nt>&#34;Fields&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=s2>&#34;10007&#34;</span>
          <span class=p>]</span>
        <span class=p>},</span>
        <span class=nt>&#34;Planet&#34;</span><span class=p>:</span> <span class=s2>&#34;Earth&#34;</span>
      <span class=p>}</span>
    <span class=p>]</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Look at all of those <code>Case</code>s and <code>Field</code>s. Yuck.</p><h2 id=the-good-news-and-the-bad-news>The good news and the bad news</h2><p>The good news is that we can serialise <em>and</em> deserialise our Customer record into really clean json. The bad news is that you&rsquo;re going to have to wait for the next installment.</p><p>Remember you can check out the source for this post at <a href=https://github.com/troykershaw/signalr-fsharp-getting-started>github.com/troykershaw/signalr-fsharp-getting-started</a>.</p><p>Merry Christmas everyone!</p></div><div class=paginator><a class=link href=https://www.troykershaw.com/post/xamarin-forms-and-fsharp-in-a-minute/>← prev</a>
<a class=link href=https://www.troykershaw.com/post/the-asyncarrow/>next →</a></div></main><footer id=footer><div><span>© 2014</span> - <span>2020</span></div><div class=footnote><span><a class=link href=https://github.com/troykershaw>GitHub</a> | <a class=link href=https://www.linkedin.com/in/troykershaw>LinkedIn</a> | <a class=link href=/index.xml>RSS</a></span></div></footer></div></body></html>